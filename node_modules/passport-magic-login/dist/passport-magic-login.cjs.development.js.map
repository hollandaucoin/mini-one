{"version":3,"file":"passport-magic-login.cjs.development.js","sources":["../src/token.ts","../src/index.ts"],"sourcesContent":["import jwt, { SignOptions } from 'jsonwebtoken';\n\ntype JwtPayload = {\n  destination: string;\n  code: string;\n  [key: string]: any;\n};\n\nexport const decodeToken = (secret: string, token?: string) => {\n  if (typeof token !== 'string') throw new Error('No token provided');\n\n  return jwt.verify(token, secret);\n};\n\nexport const generateToken = (\n  secret: string,\n  payload: JwtPayload,\n  options: SignOptions = { expiresIn: '60min' }\n) => jwt.sign(payload, secret, options);\n","import { Request, Response } from 'express';\nimport { SignOptions } from 'jsonwebtoken';\nimport { StrategyCreatedStatic } from 'passport';\nimport { generateToken, decodeToken } from './token';\n\ntype VerifyCallback = (\n  payload: any,\n  verifyCallback: (err?: Error | null, user?: Object, info?: any) => void,\n  req: Request\n) => void;\n\ninterface Options {\n  secret: string;\n  callbackUrl: string;\n  jwtOptions?: SignOptions;\n  sendMagicLink: (\n    destination: string,\n    href: string,\n    verificationCode: string,\n    req: Request\n  ) => Promise<void>;\n  verify: VerifyCallback;\n\n  /** @deprecated */\n  confirmUrl?: string;\n}\n\nclass MagicLoginStrategy {\n  name: string = 'magiclogin';\n\n  constructor(private _options: Options) {}\n\n  authenticate(\n    this: StrategyCreatedStatic & MagicLoginStrategy,\n    req: Request\n  ): void {\n    const self = this;\n\n    let payload = null;\n\n    try {\n      payload = decodeToken(\n        self._options.secret,\n        (req.query.token || req.body?.token) as string\n      );\n    } catch (error) {\n      const defaultMessage = 'No valid token provided';\n      const message = error instanceof Error ? error.message : defaultMessage;\n\n      return self.fail(message);\n    }\n\n    const verifyCallback = function(\n      err?: Error | null,\n      user?: Object,\n      info?: any\n    ) {\n      if (err) {\n        return self.error(err);\n      } else if (!user) {\n        return self.fail(info);\n      } else {\n        return self.success(user, info);\n      }\n    };\n\n    self._options.verify(payload, verifyCallback, req);\n  }\n\n  send = (req: Request, res: Response): void => {\n    const payload = req.method === 'GET' ? req.query : req.body;\n    if (\n      req.method === 'POST' &&\n      !req.headers['content-type']?.match('application/json')\n    ) {\n      res\n        .status(400)\n        .send('Content-Type must be application/json when using POST method.');\n      return;\n    }\n\n    if (!payload.destination) {\n      res.status(400).send('Please specify the destination.');\n      return;\n    }\n\n    const code = Math.floor(Math.random() * 90000) + 10000 + '';\n    const jwt = generateToken(\n      this._options.secret,\n      {\n        ...payload,\n        code,\n      },\n      this._options.jwtOptions\n    );\n\n    this._options\n      .sendMagicLink(\n        payload.destination,\n        `${this._options.callbackUrl}?token=${jwt}`,\n        code,\n        req\n      )\n      .then(() => {\n        res.json({ success: true, code });\n      })\n      .catch((error: any) => {\n        console.error(error);\n        res.json({ success: false, error });\n      });\n  };\n\n  /** @deprecated */\n  confirm = (req: Request, res: Response): void => {\n    console.warn(\n      `magicLink.confirm was removed in v1.0.7, it is no longer necessary.`\n    );\n    res.redirect(`${this._options.callbackUrl}?token=${req.query.token}`);\n  };\n}\n\nexport default MagicLoginStrategy;\n"],"names":["decodeToken","secret","token","Error","jwt","verify","generateToken","payload","options","expiresIn","sign","MagicLoginStrategy","_options","req","res","method","query","body","headers","match","status","send","destination","code","Math","floor","random","jwtOptions","sendMagicLink","callbackUrl","then","json","success","error","console","warn","redirect","authenticate","self","defaultMessage","message","fail","verifyCallback","err","user","info"],"mappings":"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"}